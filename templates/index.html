<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czat z Gemini</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f4f4f9; color: #333; display: flex; flex-direction: column; height: calc(100vh - 40px); }
        h1 { color: #444; text-align: center; }
        #chat-container { flex-grow: 1; overflow-y: auto; background-color: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; word-wrap: break-word; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .model-message { background-color: #e9e9eb; color: #333; align-self: flex-start; }
        /* Styles for Markdown code blocks */
        .model-message pre { background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; }
        .model-message code { font-family: "Fira Code", "Courier New", monospace; }
        .model-message p:last-child { margin-bottom: 0; }
        /* Typing indicator styles */
        .typing-indicator { display: flex; align-items: center; padding: 10px 0; }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 3px;
            background-color: #9e9e9e;
            border-radius: 50%;
            display: inline-block;
            animation: wave 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes wave { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        form { display: flex; gap: 10px; }
        textarea { flex-grow: 1; padding: 10px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; resize: none; height: 50px; }
        button { padding: 0 20px; font-size: 1rem; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
    <!-- Add Marked.js for Markdown parsing and DOMPurify for security -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
</head>
<body>
    <h1>Czat z Gemini (z historią)</h1>
    <div id="chat-container"></div>
    <form id="gemini-form">
        <textarea id="question-input" name="question" rows="1" placeholder="Wpisz swoje pytanie tutaj..." required></textarea>
        <button type="submit" id="submit-button">Wyślij</button>
    </form>

    <script>
        const form = document.getElementById('gemini-form');
        const questionInput = document.getElementById('question-input');
        const chatContainer = document.getElementById('chat-container');
        const submitButton = document.getElementById('submit-button');

        let conversationHistory = [];

        questionInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });

        // Auto-resize textarea
        questionInput.addEventListener('input', () => {
            questionInput.style.height = 'auto';
            questionInput.style.height = (questionInput.scrollHeight) + 'px';
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;

            displayMessage(question, 'user');
            conversationHistory.push({ role: 'user', parts: [question] });
            questionInput.value = '';
            questionInput.style.height = 'auto'; // Reset height after sending
            
            submitButton.disabled = true;

            const modelMessageElement = displayMessage('', 'model');
            let fullModelResponse = '';
            let firstChunkReceived = false;

            try {
                // Używamy ścieżki względnej. Przeglądarka automatycznie
                // użyje tej samej domeny i portu, z której serwowana jest strona.
                // To najlepsza praktyka, która działa zarówno lokalnie, jak i w Cloud Shell.
                const response = await fetch('/gemini/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, history: conversationHistory }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    if (!firstChunkReceived && chunk) {
                        firstChunkReceived = true;
                        modelMessageElement.innerHTML = ''; // Clear the typing indicator
                    }

                    fullModelResponse += chunk;
                    // Parse Markdown and sanitize the HTML for security before displaying
                    const dirtyHtml = marked.parse(fullModelResponse);
                    modelMessageElement.innerHTML = DOMPurify.sanitize(dirtyHtml);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            } catch (error) {
                modelMessageElement.textContent = `Wystąpił błąd: ${error.message}`;
                console.error('Fetch error:', error);
            } finally {
                if (fullModelResponse) {
                    conversationHistory.push({ role: 'model', parts: [fullModelResponse] });
                }
                submitButton.disabled = false;
                questionInput.focus();
            }
        });

        function displayMessage(text, type) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${type}-message`);
            if (type === 'user') {
                messageElement.textContent = text;
            } else {
                // For model messages, show a typing indicator
                messageElement.innerHTML = `
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                `;
            }
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageElement;
        }
    </script>
</body>
</html>
